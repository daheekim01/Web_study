## 🥞 **PHP Code Injection / Remote Code Execution**

### A. 업로드 → 웹루트에 `.php`로 저장 → Stored WebShell (가장 흔함)

취약한 `up.cgi`가 `uploads/`에 `$_FILES['file']['name']` 그대로 저장하고 `uploads/`가 웹에서 PHP를 실행하도록 설정되어 있으면 RCE.

취약점 흐름:

* POST로 `shell.php`(내용: `<?php ... ?>`) 업로드 → `/uploads/shell.php` 생성 → `GET /uploads/shell.php` 요청 → 서버가 PHP 해석 → 공격자 명령 실행.

### B. 파일명 경로 조작 → 디렉토리 트래버설

업로드 핸들러가 파일명을 `../../www/some.php`처럼 조작해서 의도한 위치(예: 웹루트)로 쓰도록 허용하면 RCE.

### C. 쉘 명령 인젝션

업로드 핸들러가 `system("mv $tmp $dest");` 처럼 외부 입력($dest)에 검증 없이 넣으면 `; rm -rf /` 같은 인젝션 가능.

### D. 로그 포이즈닝 + LFI

* 공격자가 로그(예: access.log)에 `<?php ... ?>`를 주입하고, 어딘가 LFI 취약점이 있으면 `include('/var/log/apache2/access.log')`로 인해 코드 실행 가능.

---


### 예시 1. **파일 업로드/POST(멀티파트)** 형태로 PHP 코드(웹셸)를 전송

```
,<?php echo md5('999999999'); unlink(__FILE__); ?> 
-----------------------------5825462663702204104870787337-- 
/api/hassio/app/../supervisor/info
/setup/setup-s/../../log.jsp
```

* `<?php ... ?>` — PHP 코드. 관리자 페이지나 업로드된 파일이 PHP로 해석되면 **코드 실행**.
* `echo md5('999999999')` — *실행 확인용(증거 표시) 페이로드*. 공격자는 실행 결과(특정 해시값)를 보고 “코드가 실행되었다”를 확인하려 함.
* `unlink(__FILE__)` — 자신(업로드된 파일)을 삭제해서 흔적을 지우려는 동작.
* `-----------------------------...--` — multipart/form-data 바운더리(업로드 요청의 끝).
* `/api/hassio/...`, `/setup/.../../../log.jsp` — 추가적인 경로 탐색/트래버설 시도(내부 엔드포인트·로그 파일 접근 시도).

1. **멀티파트 POST로 파일 업로드(또는 필드에 코드 주입)**

   * boundary와 `<?php ... ?>` 조합은 “파일 업로드(body에 들어있는 파일 또는 필드)에 PHP 코드 삽입”을 의미합니다.
2. **업로드 파일이 웹 접근 가능한 위치에 저장되면**

   * 공격자는 그 업로드된 파일(예: `http://friend.com/uploads/a.php`)을 GET 요청해 PHP 코드를 실행시키려 시도합니다.
   * `echo md5('999999999')` 출력이 보이면 공격자는 “실행 확인” -> 그 값이 로그/응답에 남으면 성공으로 판단.
3. **실행 후 흔적 지우기**

   * `unlink(__FILE__)`로 자기 자신을 삭제하여 업로드된 웹쉘 파일을 지운 뒤에도 이미 실행된 공격 작업(예: 명령·백그라운드 작업)은 남아있을 수 있음.
4. **동시에 다른 경로 스캐닝/트래버설 시도**

   * `/api/hassio/app/../supervisor/info` 등은 내부 엔드포인트(정보 노출 가능)를 탐색하려는 시도.
   * `/setup/.../../../log.jsp`는 상위 디렉터리 접근을 통해 로그/설정 파일을 읽어보려는 시도(혹은 기존 취약점 유무 확인).
5. **결과**

   * 성공하면 공격자는 서버에서 임의 명령 실행, 데이터 탈취, 네트워크 확장(다른 공격자 연결), 또는 시스템 장악을 진행할 수 있습니다.



### RCE가 되는 경우 

1. **up.cgi가 업로드된 파일을 웹 루트(또는 PHP가 해석되는 위치)에 그대로 저장**하고 그 파일이 `.php` 등으로 접근 가능하면 → 업로드된 PHP가 HTTP로 호출될 때 서버가 그 PHP를 해석하여 **코드 실행(Stored RCE)** 발생.
2. **up.cgi가 업로드된 입력(또는 파라미터 값)을 `system()`/`exec()` 같은 쉘 호출에 검증 없이 넣는 경우** → 명령 인젝션 → RCE.
3. **업로드 후 바로 include/require 하거나 템플릿 엔진에 그대로 넣어 서버에서 해석되게 하는 경우** → 템플릿 인젝션 → RCE.
4. **서버에 오래된 Bash 취약점 같은 외부 런타임 취약점이 존재**하면 환경변수/페이로드를 통해 원격 실행 가능.
   
**up.cgi가 어떻게 동작하는지(파일 저장 위치 · 확장자 허용 · 실행 권한 · 쉘 호출 여부)**가 관건입니다.



---

### 예시 2  `create_function`과 `usort()` 등을 이용해 동적으로 코드 실행을 시도

```txt
tag/index=&tag={
  pbohome/Indexot:if(1)(
    usort(
      post(1),
      create_function(
        post(2),
        post(3)
      )
    )
  );
}(123){/pbhome/Indexoot:if}&tagstpl=news.html&lnoc2tspfar1_ue
```

(※ `%7B`, `%7D` → `{`, `}`,
`/*%3e*/` → `/*>*/` 로 변형해 난독화된 상태)


## 📌 주요 요소 분석

### 1. **`create_function` 사용**

```php
create_function(post(2), post(3))
```

* 이는 PHP의 오래된 함수로, 문자열 형태의 코드를 함수로 생성할 수 있음.
* PHP 7.2 이후 제거되었지만, **구버전에서는 치명적인 RCE 수단**으로 쓰임.

### 2. **`usort(post(1), ..., ...)`**

* `usort()`은 배열 정렬 함수인데, 콜백 함수에 **임의 코드 실행을 유도**할 수 있음.
* `post(n)` 구조는 공격자가 자신이 원하는 데이터를 POST로 넘기겠다는 의미일 수 있음.

### 3. **난독화 (`/*%3e*/`, 중첩 괄호, `tag=` 파라미터 활용 등)**

* 필터 우회를 위해 일부 문자들을 주석 처리하거나 인코딩
* 예: WAF가 `create_function`을 막더라도 `cre/*>*/ate_function`처럼 쪼개면 우회 가능

---

## 📌 목적은?

이 페이로드의 목적은:

> 🔥 서버가 이 입력값을 **eval, include, unserialize, preg\_replace** 등으로 실행하게 만들어서
> **임의 코드 실행** → **웹쉘 삽입** → **시스템 장악**

---

## 🔴 결론: **공격 시도임 (고위험)**

이건 **고도로 난독화된 코드 인젝션** 시도로,
**PHP 구버전 기반의 취약 웹사이트**를 타겟으로 만들어진 공격 페이로드입니다.

---

## ✅ 대응 방안

| 항목           | 조치                                                                          |
| ------------ | --------------------------------------------------------------------------- |
| 서버 코드 확인     | 이 `tag` 파라미터나 `create_function`, `usort`가 사용자 입력으로 실행되는지 확인                 |
| PHP 버전 업그레이드 | `create_function`은 PHP 7.2부터 제거됨 — 최신 PHP로 필수 업그레이드                         |
| 입력 필터링       | `tag`, `tagstpl` 같은 파라미터에서 `{}`, `(`, `)`, `;`, `create_function` 등의 문자열 차단 |
| WAF 룰 설정     | 해당 문자열 패턴 탐지/차단하는 룰 추가 (또는 ModSecurity 사용)                                  |
| 로그 확인        | 이 요청을 보낸 IP 및 유사 요청의 빈도 파악 → IP 차단 또는 경고 설정                                 |

---

좋습니다. 지금 보여주신 내용은 **WAF(Web Application Firewall) 또는 IDS/IPS 시스템의 탐지 룰 정의**로 보이며, 두 가지 PHP 관련 공격 시도를 감지하기 위한 것입니다.

---

## 📌 룰 요약

| 룰 ID      | 이름                                                               | 탐지 대상                                  | 탐지 내용   |
| --------- | ---------------------------------------------------------------- | -------------------------------------- | ------- |
| `3000154` | CMD Injection Attack Detected (Common PHP Function Detected) v.1 | `ARGS_NAMES:<?php echo md5("cmd"); ?>` | `md5(`  |
| `969151`  | PHP Injection Attack (Opening Tag) v.1                           | `ARGS_NAMES:<?php echo md5("cmd"); ?>` | `<?php` |

---

## 🔍 세부 분석

### 🛠️ 1. `rule: 3000154`

#### 이름:

**CMD Injection Attack Detected (Common PHP Function Detected) v.1**

#### 목적:

* PHP 코드 중 **명령어 실행 또는 문자열 조작**에 자주 쓰이는 함수 감지
* 특히 `md5(` 같은 함수는 **우회 체크나 해시 조작에 사용되는 흔한 패턴**

#### 탐지 기준:

* \*\*파라미터 이름 (`ARGS_NAMES`)\*\*이 이 값을 포함:

```php
<?php echo md5("cmd"); ?>
```

* 이 안에 **`md5(`** 가 있는 경우 탐지

> ☑️ 의미: 공격자가 **파라미터 이름에 PHP 코드**를 심어서 서버가 이를 처리하게 만들려는 시도

---

### 🛠️ 2. `rule: 969151`

#### 이름:

**PHP Injection Attack (Opening Tag) v.1**

#### 목적:

* PHP 코드 인젝션 탐지
* 특히 `<?php` 태그는 PHP 코드의 시작을 의미하므로 **가장 명백한 인젝션 시그니처 중 하나**

#### 탐지 기준:

* 마찬가지로 `ARGS_NAMES`에 `<?php echo md5("cmd"); ?>` 같은 입력이 있고
* 그 안에 `<?php` 가 포함되어 있다면 탐지

---

## 🤔 그런데 왜 `ARGS_NAMES`?

보통 WAF 룰에서는:

* `ARGS` → **요청 파라미터의 값**
* `ARGS_NAMES` → **요청 파라미터의 이름**

예: 이 URL을 보세요 👇

```
/test.php?<?php echo md5("cmd"); ?>=value
```

여기서:

* 파라미터 이름: `<?php echo md5("cmd"); ?>`
* 파라미터 값: `value`

☠️ 이런 요청은 **누가 봐도 해킹 시도**입니다.
왜냐하면 파라미터 "이름"에 PHP 코드를 넣었기 때문입니다.
그리고 서버 코드가 이 파라미터 이름을 기반으로 어떤 동작을 하게 된다면,
**RCE(원격 코드 실행)** 가능성도 생깁니다.

---

## 🎯 핵심 요약

| 항목    | 내용                                               |
| ----- | ------------------------------------------------ |
| 탐지 대상 | HTTP 파라미터 "이름" (ARGS\_NAMES)                     |
| 공격 목적 | PHP 코드 인젝션 / 명령어 실행 함수 (`md5`, `<?php`) 포함       |
| 위험도   | 🔥 매우 높음 – 인젝션 또는 RCE 가능성                        |
| 우회 방지 | 주석, 인코딩 등 필터 우회 방식도 추가 룰 필요                      |
| 대응 방안 | 룰 작동 확인, 로그 경고, IP 차단 또는 CAPTCHA, 응답 지연 등 보완책 적용 |

---
④ body에 
<?php 
$_POST/**/[,  
,base64_decode(  문자열 포함




위의 요청은 파일 이름을 전달하는 API에서 쉘 명령어를 주입하여 파일 삭제나 시스템 명령어 실행을 유도할 수 있습니다.


